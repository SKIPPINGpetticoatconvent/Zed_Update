name: Build Windows Executable

on:
  push:
    branches: [main, master]
    tags: ["v*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: false
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      create_release:
        description: "Create release after build"
        required: false
        default: true
        type: boolean

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      should_release: ${{ steps.version.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version and generate new version
        id: version
        run: |
          # è·å–å½“å‰æœ€æ–°çš„æ ‡ç­¾ç‰ˆæœ¬
          LATEST_TAG=$(git tag -l "v*" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)

          if [ -z "$LATEST_TAG" ]; then
            # å¦‚æœæ²¡æœ‰æ ‡ç­¾ï¼Œä» v1.0.0 å¼€å§‹
            LATEST_TAG="v1.0.0"
            CURRENT_VERSION="1.0.0"
          else
            CURRENT_VERSION=${LATEST_TAG#v}
          fi

          echo "Current version: $CURRENT_VERSION"

          # è§£æç‰ˆæœ¬å·
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          # æ ¹æ®è§¦å‘ç±»å‹å†³å®šæ˜¯å¦éœ€è¦å‘å¸ƒ
          SHOULD_RELEASE="false"
          VERSION_TYPE="${{ github.event.inputs.version_type || 'patch' }}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "push" ]; then
            if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
              SHOULD_RELEASE="true"

              # è®¡ç®—æ–°ç‰ˆæœ¬å·
              case $VERSION_TYPE in
                major)
                  MAJOR=$((MAJOR + 1))
                  MINOR=0
                  PATCH=0
                  ;;
                minor)
                  MINOR=$((MINOR + 1))
                  PATCH=0
                  ;;
                patch)
                  PATCH=$((PATCH + 1))
                  ;;
              esac
            fi
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          NEW_TAG="v$NEW_VERSION"

          echo "New version: $NEW_VERSION"
          echo "New tag: $NEW_TAG"
          echo "Should release: $SHOULD_RELEASE"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT

  build-windows:
    runs-on: windows-latest
    needs: version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Update version in files
        run: |
          $version = "${{ needs.version.outputs.version }}"

          # æ›´æ–°ä¸»ç¨‹åºä¸­çš„ç‰ˆæœ¬å·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (Test-Path "main.py") {
            (Get-Content "main.py") -replace 'setApplicationVersion\(".*?"\)', "setApplicationVersion(`"$version`")" | Set-Content "main.py"
          }

          # åˆ›å»ºæˆ–æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
          @"
          VERSION = "$version"
          BUILD_DATE = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          BUILD_COMMIT = "${{ github.sha }}"
          "@ | Out-File -FilePath "version.py" -Encoding UTF8

          echo "Updated version to: $version"

      - name: Create PyInstaller spec file
        run: |
          echo "# -*- mode: python ; coding: utf-8 -*-" > ZedUpdater.spec
          echo "import sys" >> ZedUpdater.spec
          echo "from pathlib import Path" >> ZedUpdater.spec
          echo "" >> ZedUpdater.spec
          echo "block_cipher = None" >> ZedUpdater.spec
          echo "" >> ZedUpdater.spec
          echo "a = Analysis(" >> ZedUpdater.spec
          echo "    ['main.pyw']," >> ZedUpdater.spec
          echo "    pathex=[]," >> ZedUpdater.spec
          echo "    binaries=[]," >> ZedUpdater.spec
          echo "    datas=[" >> ZedUpdater.spec
          echo "        ('config.example.json', '.')," >> ZedUpdater.spec
          echo "        ('main.py', '.')," >> ZedUpdater.spec
          echo "        ('updater', 'updater')," >> ZedUpdater.spec
          echo "    ]," >> ZedUpdater.spec
          echo "    hiddenimports=[" >> ZedUpdater.spec
          echo "        'PyQt5.sip'," >> ZedUpdater.spec
          echo "        'PyQt5.QtCore'," >> ZedUpdater.spec
          echo "        'PyQt5.QtWidgets'," >> ZedUpdater.spec
          echo "        'PyQt5.QtGui'," >> ZedUpdater.spec
          echo "        'win32api'," >> ZedUpdater.spec
          echo "        'win32con'," >> ZedUpdater.spec
          echo "        'win32file'," >> ZedUpdater.spec
          echo "        'win32gui'," >> ZedUpdater.spec
          echo "        'win32process'," >> ZedUpdater.spec
          echo "        'pywintypes'," >> ZedUpdater.spec
          echo "        'psutil'," >> ZedUpdater.spec
          echo "        'schedule'," >> ZedUpdater.spec
          echo "        'requests'," >> ZedUpdater.spec
          echo "        'chardet'," >> ZedUpdater.spec
          echo "        'dateutil'," >> ZedUpdater.spec
          echo "        'ctypes'," >> ZedUpdater.spec
          echo "        'ctypes.wintypes'," >> ZedUpdater.spec
          echo "    ]," >> ZedUpdater.spec
          echo "    hookspath=[]," >> ZedUpdater.spec
          echo "    hooksconfig={}," >> ZedUpdater.spec
          echo "    runtime_hooks=[]," >> ZedUpdater.spec
          echo "    excludes=[]," >> ZedUpdater.spec
          echo "    win_no_prefer_redirects=False," >> ZedUpdater.spec
          echo "    win_private_assemblies=False," >> ZedUpdater.spec
          echo "    cipher=block_cipher," >> ZedUpdater.spec
          echo "    noarchive=False," >> ZedUpdater.spec
          echo ")" >> ZedUpdater.spec
          echo "" >> ZedUpdater.spec
          echo "pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)" >> ZedUpdater.spec
          echo "" >> ZedUpdater.spec
          echo "exe = EXE(" >> ZedUpdater.spec
          echo "    pyz," >> ZedUpdater.spec
          echo "    a.scripts," >> ZedUpdater.spec
          echo "    a.binaries," >> ZedUpdater.spec
          echo "    a.zipfiles," >> ZedUpdater.spec
          echo "    a.datas," >> ZedUpdater.spec
          echo "    []," >> ZedUpdater.spec
          echo "    name='ZedUpdater'," >> ZedUpdater.spec
          echo "    debug=False," >> ZedUpdater.spec
          echo "    version_info=('${{ needs.version.outputs.version }}', '${{ needs.version.outputs.version }}', 'ZedUpdater', 'Zed Editor Auto Updater')," >> ZedUpdater.spec
          echo "    bootloader_ignore_signals=False," >> ZedUpdater.spec
          echo "    strip=False," >> ZedUpdater.spec
          echo "    upx=True," >> ZedUpdater.spec
          echo "    upx_exclude=[]," >> ZedUpdater.spec
          echo "    runtime_tmpdir=None," >> ZedUpdater.spec
          echo "    console=False," >> ZedUpdater.spec
          echo "    disable_windowed_traceback=True," >> ZedUpdater.spec
          echo "    argv_emulation=False," >> ZedUpdater.spec
          echo "    target_arch=None," >> ZedUpdater.spec
          echo "    codesign_identity=None," >> ZedUpdater.spec
          echo "    entitlements_file=None," >> ZedUpdater.spec
          echo ")" >> ZedUpdater.spec

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --clean ZedUpdater.spec

      - name: Create additional GUI launchers
        run: |
          # Create console version for debugging
          echo "# -*- mode: python ; coding: utf-8 -*-" > ZedUpdater-Console.spec
          echo "import sys" >> ZedUpdater-Console.spec
          echo "from pathlib import Path" >> ZedUpdater-Console.spec
          echo "" >> ZedUpdater-Console.spec
          echo "block_cipher = None" >> ZedUpdater-Console.spec
          echo "" >> ZedUpdater-Console.spec
          echo "a = Analysis(" >> ZedUpdater-Console.spec
          echo "    ['main.py']," >> ZedUpdater-Console.spec
          echo "    pathex=[]," >> ZedUpdater-Console.spec
          echo "    binaries=[]," >> ZedUpdater-Console.spec
          echo "    datas=[" >> ZedUpdater-Console.spec
          echo "        ('config.example.json', '.')," >> ZedUpdater-Console.spec
          echo "        ('main.pyw', '.')," >> ZedUpdater-Console.spec
          echo "        ('updater', 'updater')," >> ZedUpdater-Console.spec
          echo "    ]," >> ZedUpdater-Console.spec
          echo "    hiddenimports=[" >> ZedUpdater-Console.spec
          echo "        'PyQt5.sip'," >> ZedUpdater-Console.spec
          echo "        'PyQt5.QtCore'," >> ZedUpdater-Console.spec
          echo "        'PyQt5.QtWidgets'," >> ZedUpdater-Console.spec
          echo "        'PyQt5.QtGui'," >> ZedUpdater-Console.spec
          echo "        'win32api'," >> ZedUpdater-Console.spec
          echo "        'win32con'," >> ZedUpdater-Console.spec
          echo "        'win32file'," >> ZedUpdater-Console.spec
          echo "        'win32gui'," >> ZedUpdater-Console.spec
          echo "        'win32process'," >> ZedUpdater-Console.spec
          echo "        'pywintypes'," >> ZedUpdater-Console.spec
          echo "        'psutil'," >> ZedUpdater-Console.spec
          echo "        'schedule'," >> ZedUpdater-Console.spec
          echo "        'requests'," >> ZedUpdater-Console.spec
          echo "        'chardet'," >> ZedUpdater-Console.spec
          echo "        'dateutil'," >> ZedUpdater-Console.spec
          echo "        'ctypes'," >> ZedUpdater-Console.spec
          echo "        'ctypes.wintypes'," >> ZedUpdater-Console.spec
          echo "    ]," >> ZedUpdater-Console.spec
          echo "    hookspath=[]," >> ZedUpdater-Console.spec
          echo "    hooksconfig={}," >> ZedUpdater-Console.spec
          echo "    runtime_hooks=[]," >> ZedUpdater-Console.spec
          echo "    excludes=[]," >> ZedUpdater-Console.spec
          echo "    win_no_prefer_redirects=False," >> ZedUpdater-Console.spec
          echo "    win_private_assemblies=False," >> ZedUpdater-Console.spec
          echo "    cipher=block_cipher," >> ZedUpdater-Console.spec
          echo "    noarchive=False," >> ZedUpdater-Console.spec
          echo ")" >> ZedUpdater-Console.spec
          echo "" >> ZedUpdater-Console.spec
          echo "pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)" >> ZedUpdater-Console.spec
          echo "" >> ZedUpdater-Console.spec
          echo "exe = EXE(" >> ZedUpdater-Console.spec
          echo "    pyz," >> ZedUpdater-Console.spec
          echo "    a.scripts," >> ZedUpdater-Console.spec
          echo "    a.binaries," >> ZedUpdater-Console.spec
          echo "    a.zipfiles," >> ZedUpdater-Console.spec
          echo "    a.datas," >> ZedUpdater-Console.spec
          echo "    []," >> ZedUpdater-Console.spec
          echo "    name='ZedUpdater-Console'," >> ZedUpdater-Console.spec
          echo "    debug=False," >> ZedUpdater-Console.spec
          echo "    version_info=('${{ needs.version.outputs.version }}', '${{ needs.version.outputs.version }}', 'ZedUpdater Console', 'Zed Editor Auto Updater Console')," >> ZedUpdater-Console.spec
          echo "    bootloader_ignore_signals=False," >> ZedUpdater-Console.spec
          echo "    strip=False," >> ZedUpdater-Console.spec
          echo "    upx=True," >> ZedUpdater-Console.spec
          echo "    upx_exclude=[]," >> ZedUpdater-Console.spec
          echo "    runtime_tmpdir=None," >> ZedUpdater-Console.spec
          echo "    console=True," >> ZedUpdater-Console.spec
          echo "    disable_windowed_traceback=False," >> ZedUpdater-Console.spec
          echo "    argv_emulation=False," >> ZedUpdater-Console.spec
          echo "    target_arch=None," >> ZedUpdater-Console.spec
          echo "    codesign_identity=None," >> ZedUpdater-Console.spec
          echo "    entitlements_file=None," >> ZedUpdater-Console.spec
          echo ")" >> ZedUpdater-Console.spec

          pyinstaller --clean ZedUpdater-Console.spec

      - name: Test executable
        run: |
          # Test GUI launch (should not hang in headless environment)
          timeout 10 dist\ZedUpdater.exe --help || echo "Expected timeout in headless environment"
        timeout-minutes: 2
        continue-on-error: true

      - name: Get file size and info
        run: |
          Get-ChildItem dist\ZedUpdater.exe | Format-List Name, Length, CreationTime
          echo "File size: $((Get-Item dist\ZedUpdater.exe).Length / 1MB) MB"

      - name: Create portable packages
        run: |
          # Create GUI-only portable package
          mkdir ZedUpdater-GUI-Portable
          copy dist\ZedUpdater.exe ZedUpdater-GUI-Portable\
          copy config.example.json ZedUpdater-GUI-Portable\config.json
          copy README.md ZedUpdater-GUI-Portable\ -ErrorAction SilentlyContinue
          copy LICENSE ZedUpdater-GUI-Portable\ -ErrorAction SilentlyContinue
          copy CHANGELOG.md ZedUpdater-GUI-Portable\ -ErrorAction SilentlyContinue
          copy QUICK_START.md ZedUpdater-GUI-Portable\ -ErrorAction SilentlyContinue
          # copy main.pyw instead of non-existent gui_launcher.pyw
          copy main.pyw ZedUpdater-GUI-Portable\ -ErrorAction SilentlyContinue
          copy start_gui.bat ZedUpdater-GUI-Portable\ -ErrorAction SilentlyContinue
          copy start_gui_silent.vbs ZedUpdater-GUI-Portable\ -ErrorAction SilentlyContinue

          # Create batch files for GUI usage (no console window)
          echo "@echo off" > ZedUpdater-GUI-Portable\start-gui.bat
          echo "start /b ZedUpdater.exe --gui" >> ZedUpdater-GUI-Portable\start-gui.bat

          echo "@echo off" > ZedUpdater-GUI-Portable\start-gui-silent.bat
          echo "ZedUpdater.exe --gui" >> ZedUpdater-GUI-Portable\start-gui-silent.bat

          # Create VBS script for completely silent launch
          echo "Set objShell = CreateObject(""WScript.Shell"")" > ZedUpdater-GUI-Portable\start-gui-invisible.vbs
          echo "objShell.Run ""ZedUpdater.exe --gui"", 0, False" >> ZedUpdater-GUI-Portable\start-gui-invisible.vbs
          echo "Set objShell = Nothing" >> ZedUpdater-GUI-Portable\start-gui-invisible.vbs

          # Create usage instructions for GUI package
          echo "# ZedUpdater GUIç‰ˆ ä½¿ç”¨è¯´æ˜" > ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "## å¯åŠ¨æ–¹å¼:" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "1. ZedUpdater.exe            - ç›´æ¥è¿è¡Œç¨‹åº (é»˜è®¤GUIæ¨¡å¼ï¼Œæ— æ§åˆ¶å°)" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "2. start-gui.bat             - å¯åŠ¨GUIç•Œé¢ (æ¨è)" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "3. start-gui-silent.bat      - å¯åŠ¨GUIç•Œé¢ (é™é»˜æ¨¡å¼)" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "4. start-gui-invisible.vbs   - å®Œå…¨éšè—å¯åŠ¨GUI" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "5. main.pyw                   - Pythonå¯åŠ¨å™¨ (éœ€è¦Pythonç¯å¢ƒ)" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "## æ³¨æ„äº‹é¡¹:" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "- æ­¤ç‰ˆæœ¬ä¸ºçº¯GUIç‰ˆæœ¬ï¼Œä¸ä¼šæ˜¾ç¤ºæ§åˆ¶å°çª—å£" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "- å¦‚éœ€æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼Œè¯·æŸ¥çœ‹ zed_updater.log æ–‡ä»¶" >> ZedUpdater-GUI-Portable\ä½¿ç”¨è¯´æ˜.txt

          # Create complete portable package (with console version)
          mkdir ZedUpdater-Complete-Portable
          copy dist\ZedUpdater.exe ZedUpdater-Complete-Portable\ZedUpdater-GUI.exe
          copy dist\ZedUpdater-Console.exe ZedUpdater-Complete-Portable\ZedUpdater-Console.exe
          copy config.example.json ZedUpdater-Complete-Portable\config.json
          copy README.md ZedUpdater-Complete-Portable\ -ErrorAction SilentlyContinue
          copy LICENSE ZedUpdater-Complete-Portable\ -ErrorAction SilentlyContinue
          copy CHANGELOG.md ZedUpdater-Complete-Portable\ -ErrorAction SilentlyContinue
          copy QUICK_START.md ZedUpdater-Complete-Portable\ -ErrorAction SilentlyContinue
          # copy main.pyw instead of non-existent gui_launcher.pyw
          copy main.pyw ZedUpdater-Complete-Portable\ -ErrorAction SilentlyContinue
          copy start_gui.bat ZedUpdater-Complete-Portable\ -ErrorAction SilentlyContinue
          copy start_gui_silent.vbs ZedUpdater-Complete-Portable\ -ErrorAction SilentlyContinue

          # Create batch files for complete package
          echo "@echo off" > ZedUpdater-Complete-Portable\start-gui.bat
          echo "start /b ZedUpdater-GUI.exe --gui" >> ZedUpdater-Complete-Portable\start-gui.bat

          echo "@echo off" > ZedUpdater-Complete-Portable\start-gui-silent.bat
          echo "ZedUpdater-GUI.exe --gui" >> ZedUpdater-Complete-Portable\start-gui-silent.bat

          echo "Set objShell = CreateObject(""WScript.Shell"")" > ZedUpdater-Complete-Portable\start-gui-invisible.vbs
          echo "objShell.Run ""ZedUpdater-GUI.exe --gui"", 0, False" >> ZedUpdater-Complete-Portable\start-gui-invisible.vbs
          echo "Set objShell = Nothing" >> ZedUpdater-Complete-Portable\start-gui-invisible.vbs

          echo "@echo off" > ZedUpdater-Complete-Portable\update-only.bat
          echo "ZedUpdater-Console.exe --update" >> ZedUpdater-Complete-Portable\update-only.bat
          echo "pause" >> ZedUpdater-Complete-Portable\update-only.bat

          echo "@echo off" > ZedUpdater-Complete-Portable\debug-console.bat
          echo "ZedUpdater-Console.exe --gui" >> ZedUpdater-Complete-Portable\debug-console.bat
          echo "pause" >> ZedUpdater-Complete-Portable\debug-console.bat

          # Create comprehensive usage instructions
          echo "# ZedUpdater å®Œæ•´ç‰ˆ ä½¿ç”¨è¯´æ˜" > ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "## æ–‡ä»¶è¯´æ˜:" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "- ZedUpdater-GUI.exe         - GUIç‰ˆæœ¬ (æ— æ§åˆ¶å°çª—å£)" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "- ZedUpdater-Console.exe     - æ§åˆ¶å°ç‰ˆæœ¬ (æ˜¾ç¤ºæ§åˆ¶å°çª—å£)" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "## æ¨èå¯åŠ¨æ–¹å¼:" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "1. start-gui.bat             - å¯åŠ¨GUIç•Œé¢ (æ¨è)" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "2. start-gui-silent.bat      - é™é»˜å¯åŠ¨GUIç•Œé¢" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "3. start-gui-invisible.vbs   - å®Œå…¨éšè—å¯åŠ¨GUI" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "4. update-only.bat           - ä»…æ‰§è¡Œæ›´æ–°æ£€æŸ¥ (æ˜¾ç¤ºæ§åˆ¶å°)" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "5. debug-console.bat         - è°ƒè¯•æ¨¡å¼ (æ˜¾ç¤ºæ§åˆ¶å°)" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "## ç›´æ¥è¿è¡Œ:" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "- ZedUpdater-GUI.exe         - ç›´æ¥è¿è¡ŒGUIç‰ˆæœ¬" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt
          echo "- ZedUpdater-Console.exe     - ç›´æ¥è¿è¡Œæ§åˆ¶å°ç‰ˆæœ¬" >> ZedUpdater-Complete-Portable\ä½¿ç”¨è¯´æ˜.txt

      - name: Upload GUI executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: ZedUpdater-Windows-GUI-Single-File
          path: dist/ZedUpdater.exe
          retention-days: 30

      - name: Upload Console executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: ZedUpdater-Windows-Console-Single-File
          path: dist/ZedUpdater-Console.exe
          retention-days: 30

      - name: Upload GUI portable package
        uses: actions/upload-artifact@v4
        with:
          name: ZedUpdater-Windows-GUI-Portable
          path: ZedUpdater-GUI-Portable/
          retention-days: 30

      - name: Upload complete portable package
        uses: actions/upload-artifact@v4
        with:
          name: ZedUpdater-Windows-Complete-Portable
          path: ZedUpdater-Complete-Portable/
          retention-days: 30

  release:
    if: needs.version.outputs.should_release == 'true' || github.event.inputs.create_release == 'true'
    needs: [version, build-windows]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ›å»ºå¹¶æ¨é€æ–°æ ‡ç­¾
          git tag -a "${{ needs.version.outputs.tag }}" -m "Release ${{ needs.version.outputs.tag }}"
          git push origin "${{ needs.version.outputs.tag }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release archives
        run: |
          # Create GUI-only package
          cd ZedUpdater-Windows-GUI-Portable
          zip -r ../ZedUpdater-Windows-GUI-v${{ needs.version.outputs.tag }}.zip .
          cd ..

          # Create complete package
          cd ZedUpdater-Windows-Complete-Portable
          zip -r ../ZedUpdater-Windows-Complete-v${{ needs.version.outputs.tag }}.zip .
          cd ..

          # Create single files package
          mkdir ZedUpdater-Single-Files
          cp ZedUpdater-Windows-GUI-Single-File/ZedUpdater.exe ZedUpdater-Single-Files/ZedUpdater-GUI.exe
          cp ZedUpdater-Windows-Console-Single-File/ZedUpdater-Console.exe ZedUpdater-Single-Files/ZedUpdater-Console.exe
          zip -r ZedUpdater-Windows-SingleFiles-v${{ needs.version.outputs.tag }}.zip ZedUpdater-Single-Files/

      - name: Get release info
        id: release_info
        run: |
          echo "tag_name=${{ needs.version.outputs.tag }}" >> $GITHUB_OUTPUT
          echo "release_name=ZedUpdater ${{ needs.version.outputs.tag }}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${{ contains(needs.version.outputs.tag, 'beta') || contains(needs.version.outputs.tag, 'alpha') || contains(needs.version.outputs.tag, 'rc') || contains(needs.version.outputs.tag, 'pre') }}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          if [ -f "CHANGELOG.md" ]; then
            # Extract changelog for this version
            awk '/^## \[/{if(found) exit; if(/\[${{ needs.version.outputs.tag }}\]/) found=1; next} found' CHANGELOG.md > current_changelog.txt || echo "è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ needs.version.outputs.tag }}" > current_changelog.txt
          else
            # ç”Ÿæˆè‡ªåŠ¨æ›´æ–°æ—¥å¿—
            echo "## ğŸš€ è‡ªåŠ¨å‘å¸ƒ ${{ needs.version.outputs.tag }}" > current_changelog.txt
            echo "" >> current_changelog.txt
            echo "### ğŸ“… æ„å»ºä¿¡æ¯" >> current_changelog.txt
            echo "- **æ„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> current_changelog.txt
            echo "- **æ„å»ºåˆ†æ”¯**: ${{ github.ref_name }}" >> current_changelog.txt
            echo "- **æäº¤å“ˆå¸Œ**: ${{ github.sha }}" >> current_changelog.txt
            echo "- **ç‰ˆæœ¬ç±»å‹**: ${{ github.event.inputs.version_type || 'patch' }}" >> current_changelog.txt
            echo "" >> current_changelog.txt
            echo "### ğŸ”„ æœ€è¿‘æ›´æ”¹" >> current_changelog.txt
            # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
            git log --oneline -10 --pretty=format:"- %s" >> current_changelog.txt || echo "- æŸ¥çœ‹å®Œæ•´æäº¤å†å²è¯·è®¿é—® GitHub" >> current_changelog.txt
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ZedUpdater-Windows-GUI-v${{ needs.version.outputs.tag }}.zip
            ZedUpdater-Windows-Complete-v${{ needs.version.outputs.tag }}.zip
            ZedUpdater-Windows-SingleFiles-v${{ needs.version.outputs.tag }}.zip
          tag_name: ${{ needs.version.outputs.tag }}
          name: ${{ steps.release_info.outputs.release_name }}
          draft: false
          prerelease: ${{ steps.release_info.outputs.is_prerelease }}
          generate_release_notes: true
          body: |
            ## ğŸ‰ ZedUpdater ${{ needs.version.outputs.tag }} è‡ªåŠ¨å‘å¸ƒ

            > âš¡ è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨æ„å»ºçš„ç‰ˆæœ¬ï¼ŒåŒ…å«æœ€æ–°çš„ä»£ç æ›´æ”¹ã€‚

            ### ğŸ“¥ ä¸‹è½½é€‰é¡¹

            #### ğŸ¯ æ¨èä¸‹è½½ (GUIç‰ˆæœ¬)
            **[ZedUpdater-Windows-GUI-v${{ needs.version.outputs.tag }}.zip](https://github.com/${{ github.repository }}/releases/download/${{ needs.version.outputs.tag }}/ZedUpdater-Windows-GUI-v${{ needs.version.outputs.tag }}.zip)**
            - âœ¨ çº¯GUIç•Œé¢ï¼Œæ— æ§åˆ¶å°çª—å£
            - ğŸ“ è§£å‹å³ç”¨ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦æ–‡ä»¶
            - ğŸš€ å¤šç§å¯åŠ¨æ–¹å¼å¯é€‰

            #### ğŸ”§ å®Œæ•´ç‰ˆæœ¬ (GUI + æ§åˆ¶å°)
            **[ZedUpdater-Windows-Complete-v${{ needs.version.outputs.tag }}.zip](https://github.com/${{ github.repository }}/releases/download/${{ needs.version.outputs.tag }}/ZedUpdater-Windows-Complete-v${{ needs.version.outputs.tag }}.zip)**
            - ğŸ“¦ åŒ…å«GUIç‰ˆå’Œæ§åˆ¶å°ç‰ˆ
            - ğŸ› é€‚åˆè°ƒè¯•å’Œé«˜çº§ç”¨æˆ·
            - ğŸ’» æ”¯æŒå‘½ä»¤è¡Œæ“ä½œ

            #### ğŸ’¼ å•æ–‡ä»¶ç‰ˆæœ¬
            **[ZedUpdater-Windows-SingleFiles-v${{ needs.version.outputs.tag }}.zip](https://github.com/${{ github.repository }}/releases/download/${{ needs.version.outputs.tag }}/ZedUpdater-Windows-SingleFiles-v${{ needs.version.outputs.tag }}.zip)**
            - ğŸ¯ ä»…åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶
            - ğŸ“‹ éœ€è¦è‡ªè¡Œé…ç½®
            - ğŸƒ é€‚åˆé›†æˆåˆ°å…¶ä»–é¡¹ç›®

            ### ğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚
            - **æ“ä½œç³»ç»Ÿ**: Windows 10/11 (x64)
            - **ä¾èµ–**: æ— éœ€å®‰è£… Python ç¯å¢ƒ
            - **æƒé™**: æ— éœ€ç®¡ç†å‘˜æƒé™

            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½æ¨èçš„ GUI ç‰ˆæœ¬
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. è¿è¡Œ `start-gui.bat` æˆ–ç›´æ¥åŒå‡» `ZedUpdater.exe`
            4. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶

            ### ğŸ“‹ å¯åŠ¨æ–¹å¼è¯´æ˜

            #### GUIç‰ˆæœ¬åŒ…å«:
            - ğŸ¯ `ZedUpdater.exe` - ç›´æ¥è¿è¡Œ (æ— æ§åˆ¶å°)
            - ğŸš€ `start-gui.bat` - æ‰¹å¤„ç†å¯åŠ¨ (æ¨è)
            - ğŸ”• `start-gui-silent.bat` - é™é»˜å¯åŠ¨
            - ğŸ‘» `start-gui-invisible.vbs` - å®Œå…¨éšè—å¯åŠ¨

            #### å®Œæ•´ç‰ˆæœ¬é¢å¤–åŒ…å«:
            - ğŸ’» `ZedUpdater-Console.exe` - æ§åˆ¶å°ç‰ˆæœ¬
            - ğŸ”„ `update-only.bat` - ä»…æ‰§è¡Œæ›´æ–°
            - ğŸ› `debug-console.bat` - è°ƒè¯•æ¨¡å¼

            ### ğŸ“ é…ç½®è¯´æ˜
            - `config.json` - ä¸»é…ç½®æ–‡ä»¶
            - `zed_updater.log` - è¿è¡Œæ—¥å¿—
            - `ä½¿ç”¨è¯´æ˜.txt` - è¯¦ç»†ä½¿ç”¨è¯´æ˜

            ### ğŸ”„ æ›´æ–°å†…å®¹
            $(cat current_changelog.txt 2>/dev/null || echo "è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) è·å–è¯¦ç»†æ›´æ–°å†…å®¹")

            ### ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬å·**: ${{ needs.version.outputs.version }}
            - **ç‰ˆæœ¬ç±»å‹**: ${{ github.event.inputs.version_type || 'patch' }}
            - **è§¦å‘æ–¹å¼**: ${{ github.event_name }}
            - **æ„å»ºåˆ†æ”¯**: ${{ github.ref_name }}

            ### ğŸ› é—®é¢˜åé¦ˆ
            - [æŠ¥å‘Šé—®é¢˜](https://github.com/${{ github.repository }}/issues)
            - [æŸ¥çœ‹æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [ä½¿ç”¨æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/QUICK_START.md)

            ### ğŸ”„ è‡ªåŠ¨æ›´æ–°è¯´æ˜
            æœ¬é¡¹ç›®æ”¯æŒè‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†ï¼š
            - **Pushåˆ°mainåˆ†æ”¯**: è‡ªåŠ¨å‘å¸ƒpatchç‰ˆæœ¬
            - **æ‰‹åŠ¨è§¦å‘**: å¯é€‰æ‹©ç‰ˆæœ¬ç±»å‹ (major/minor/patch)
            - **æ ‡ç­¾ç®¡ç†**: è‡ªåŠ¨åˆ›å»ºå’Œæ¨é€ç‰ˆæœ¬æ ‡ç­¾

            ---
            **æ„å»ºä¿¡æ¯**: Python 3.11 + PyInstaller + Windows Latest
            **æ„å»ºID**: ${{ github.run_id }} | **æäº¤**: ${{ github.sha }}
            **è‡ªåŠ¨ç‰ˆæœ¬**: v${{ needs.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
